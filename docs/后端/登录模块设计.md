# 基于jwt的单点登录模块的设计

#### 接口文档   链接：https://easydoc.xyz/s/38426694   

###### 导语

> 为什么要用jwt?
>
> 1. 过去的web应用大多是单机的，一般采用session机制将http请求从**无状态**转变为**有状态**。而如今的大型应用为了提高并发，往往部署在多台服务器上，如果要实现相同功能，就可能需要把session复制到多台服务器上，这明显是一个很繁琐的操作。JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案。
> 2. session 本质上是一个保存在服务端上的一个特殊的数据结构，当session过大时，会持久化到内存。而大量的IO操作会明显降低服务端的性能，而jwt则是通过**计算**的方式权限的验证，服务端不用保存，性能在一定程度会优于Session。
>
> [jwt详解](http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)
>
> [java-jwt使用文档](https://github.com/auth0/java-jwt)

### 1. 登录功能



###### 登录逻辑预览

>1.  用户输入注册时的邮箱，密码，前端对用户输入的字段进行校验，并传回后端。
>2.  后端校验邮箱，密码。若密码校验失败返回提示，若校验成功转入3。
>3.  签发token  传回前端，前端保存



###### 登录时应该注意的问题

-  如何保证登录接口安全性？如何解决非法用户获得登录帐号后，暴力破解密码？

> 1. 使用图形验证码技术。非法用户仍可通过OCR技术识别验证码。
> 2. 禁用登录一段时间。如果同一用户登录出错一定次数后，直接禁用登录。这种方法看似很好，但是可能会让其他用户也无法登录。
> 3. 直接禁IP。如果黑客与用户在同一公网IP下，仍然会让一些用户无法登录。
> 4. 使用手机号或者邮箱发送短信验证码。有一种技术叫做短信嗅探，但目前4G通信嗅探很难实现。 

- 参数的校验放在前端



### 2.注册逻辑

###### 注册逻辑预览

>1. 前端校验字段并传送字段
>
>2. 后端检测用户是否已经注册过，若注册过，返回状态信息，若没有注册过, 转向3
>
>3. 用户信息数据入库，签发token
>
>4. 前端保存
>

###### 注册时应该注意的问题

>1. 密码的保存。密码不可使用明文存储，使用hash算法hash后存储到数据库。为了防止彩虹表攻击，采用加盐hash存储。采用基于加盐存储的hash算法Hmac。
>2. 邮箱的保存。由于邮箱需要使用，所以采用非对称加密算法RSA实现。(**弃用，非对称加密常常用于通信场景，此处直接明文保存, 加密解密可能会带来性能上的下降**)

### 3.权限认证

###### 权限认证逻辑预览

1. 最初版本

> 1. 前端带上token请求其他接口 。
> 2. 若token有效，若放行请求。
> 3. 若token无效，前端利用refreshtoken刷新token。
> 4. 若刷新失败，即refreshtoken失效，则要求用户重新登录。
> 5. 若refreshtoken未失效，则签发token。若refreshtoken马上过期，则更新refreshtoken, 否则不更新token。

​    方案评估：  做前端的学长说**双token的话会增加请求的次数，而且请求refreshtoken以后，还要把之前的请求还原出来，这样程序的性能会降低**。可以把token时间设置的长一点，于是有了下面这一版的设计。

2. 第二版解决方案  登录时候签发的token失效时间的长一点

   >1. 前端带上token请求其他接口 。
   >2. 若token有效，若放行请求。
   >3. 若token无效，直接重定向到登录界面

     方案评估： 这样做逻辑简单一点，代码也比较简单。但是token的失效时间如果长了，会出现以下问题

   - token本身来说，时间不要太长，不然，后面让其强制失效很困难。签发一个时间较长的token，后面又登录一次，又签发一个token, 之前那个token却又没法强制

      * 如果想让以前未失效的token强制失效，例如，退出登录，可以采用黑名单的模式，每次都查询一下这个token有没有在黑名单里面， 这就变成了和session一样了，jwt发挥不了它该有的作用。

      *  如果依靠登录时签发token, 可能会出现这样一种情况，**用户正在使用app的时候，可能会出现重定向到登录界面的问题。那样用户体验就太差了。**

   ​     

3. 第三版解决方案----前端同时上传token和refreshtoken, 后端负责更新token或者重定向到登录界面。

   >1. 前端带上token, refreshToken请求其他接口 。
   >2. 若token有效，放行请求。
   >3. 若token无效，refreshToken有效，重新签发token，但是不签发refreshToken(**用户登录后，refreshToken过期后后重新登录**)
   >4. 若token无效，refreshToken无效，重定向到登录界面。 
   >

4. 采用refreshToken的设计毫无意义, 还不如将token失效时间设置的长一点, 比如一个月.一个月以内登录了都不用登录.

###### 逻辑流程图



###### 权限认证解决提高用户体验

>1. 采用双token技术，本质上是解决了token过期时间短，refreshToken时间长来刷新token。当token过期后，采用refreshtoken动态刷新token。

### 4.修改密码

1. 邮箱发送给用户验证码 

2. 后台接受验证码，比对。比对成功，则修改数据库。

   



### 5.表的结构
### 5.1 用户信息表
- 1. 用户名，密码，邮箱是必填字段，非空。
  2. 性别，头像可选字段
  3. is_superuser默认为普通用户

| 字段名       | 字段意义 | 类型         |   默认     | 备注                   |
| ------------ | -------- | ------------ | -------- | -------------------------- |
| user_id      | 用户id   | int           | 无       | 主键                       |
| user_name    | 用户名   | varchar(50)   | not null | unique                     |
| password     | 密码     | varchar(200)       | not null | 加密存储                   |
| email        | 邮箱     | varchar(20)        | not null | unique                     |
| is_superuser | 角色     | int                | not null | 0代表普通用户，1代表管理员 |
| sex          | 性别     | varchar(10)       | 无       | 无                         |
| photo_url    | 图片     | varchar(200)    | 无       | 微信图片url                |




